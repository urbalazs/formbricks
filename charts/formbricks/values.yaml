# Override the name for the application.
# If not set, the chart name will be used.
nameOverride: ""

# Override the name of the application component.
# Defaults to the same value as nameOverride.
componentOverride: ""

# Override the application "part-of" label.
# Defaults to the chart name if not set.
partOfOverride: ""

##########################################################
# Formbricks Configuration
##########################################################
formbricks:
  # REQUIRED: Base URL of the site (e.g., https://formbricks.example.com)
  # This is used for WEBAPP_URL and NEXTAUTH_URL
  webappUrl: ""
  
  # Optional: Public URL for surveys (defaults to webappUrl if not set)
  publicUrl: ""

##########################################################
# Enterprise Configuration
##########################################################
enterprise:
  enabled: false
  licenseKey: ""

##########################################################
# Database Migration Job Configuration Helm
##########################################################
migration:
  # Enable migration job for ArgoCD deployments
  # When enabled, migrations run as a PreSync hook before the deployment
  # and the startup migration in the container is skipped
  enabled: true

  # Additional annotations for the migration job
  annotations: {}

  # Time to keep the job after completion (seconds)
  ttlSecondsAfterFinished: 300

  # Number of retries before marking the job as failed
  backoffLimit: 3

  # Resource requests and limits for the migration job
  resources:
    limits:
      memory: 512Mi
    requests:
      memory: 256Mi
      cpu: "100m"

##########################################################
# Deployment Configuration
##########################################################
deployment:
  # Deployment strategy configuration
  strategy:
    type: RollingUpdate # Type of deployment strategy (RollingUpdate/Recreate)
    # rollingUpdate:
    #   maxSurge: 25%
    #   maxUnavailable: 25%

  # Automatically reload deployment when ConfigMaps or Secrets change
  reloadOnChange: false

  # NodeSelector for scheduling pods on specific nodes
  nodeSelector: {}

  # Additional labels for Deployment
  additionalLabels: {}

  # Additional pod labels to be used in the Service's label selector
  additionalPodLabels: {}

  # Deployment annotations
  annotations: {}

  # Additional pod annotations
  additionalPodAnnotations: {}

  # Number of replicas
  replicas: 1

  # Image pull secrets for private container registries
  imagePullSecrets: ""

  # Environment variables from ConfigMaps or Secrets
  envFrom:
    # app-secrets:
    #   type: secret
    #   nameSuffix: app-secrets

  # Environment variables passed to the app container
  env: {}

  # Tolerations for scheduling pods on tainted nodes
  tolerations: []

  # Pod affinity and anti-affinity rules
  affinity: {}

  # Topology spread constraints for better scheduling
  topologySpreadConstraints: []

  # Number of previous ReplicaSet versions to retain
  revisionHistoryLimit: 2

  # Application container image
  image:
    repository: "ghcr.io/formbricks/formbricks"
    tag: "" # Defaults to appVersion if not set
    digest: "" # If set, digest takes precedence over the tag
    pullPolicy: IfNotPresent

  # Health probes configuration
  probes:
    startupProbe:
      failureThreshold: 30
      periodSeconds: 10
      tcpSocket:
        port: 3000

    readinessProbe:
      failureThreshold: 5
      periodSeconds: 10
      successThreshold: 1
      timeoutSeconds: 5
      initialDelaySeconds: 10
      httpGet:
        path: /health
        port: 3000

    livenessProbe:
      failureThreshold: 5
      periodSeconds: 10
      successThreshold: 1
      timeoutSeconds: 5
      initialDelaySeconds: 10
      httpGet:
        path: /health
        port: 3000

  # Resource requests and limits
  resources:
    limits:
      memory: 2Gi
    requests:
      memory: 1Gi
      cpu: "1"

  # Container security context
  containerSecurityContext:
    readOnlyRootFilesystem: true
    runAsNonRoot: true

  # Pod security context
  securityContext: {}

  # Command override
  command: []

  # Arguments override
  args: []

  # Container ports
  ports:
    http:
      containerPort: 3000
      protocol: TCP
      exposed: true
    metrics:
      containerPort: 9464
      protocol: TCP
      exposed: true

##########################################################
# Horizontal Pod Autoscaler (HPA)
##########################################################
autoscaling:
  enabled: true # Enable/disable HPA
  additionalLabels: {} # Additional labels for the HPA resource
  annotations: {} # Annotations for HPA
  minReplicas: 1 # Minimum number of replicas
  maxReplicas: 10 # Maximum number of replicas
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 60
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300 # Wait 5 minutes before scaling down to prevent thrashing
      policies:
        - type: Pods
          value: 1
          periodSeconds: 120 # Remove at most 1 pod every 2 minutes
    scaleUp:
      stabilizationWindowSeconds: 60 # Wait 1 minute before scaling up
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60 # Add at most 2 pods every minute

##########################################################
# Pod Disruption Budget (PDB)
#
# Ensures a minimum number of pods remain available during
# voluntary disruptions (node drains, cluster upgrades, etc.).
#
# IMPORTANT:
#   - minAvailable and maxUnavailable are MUTUALLY EXCLUSIVE.
#     Setting both will cause a helm install/upgrade failure.
#     To switch, set the unused one to null in your override file.
#   - Accepts an integer (e.g., 1) or a percentage string (e.g., "25%").
#   - For PDB to provide real HA protection, ensure
#     autoscaling.minReplicas >= 2 (or deployment.replicas >= 2
#     if HPA is disabled). With only 1 replica and minAvailable: 1,
#     the PDB will block ALL node drains and cluster upgrades.
##########################################################
pdb:
  enabled: true
  additionalLabels: {}
  annotations: {}

  # Minimum pods that must remain available during disruptions.
  # Set to null and configure maxUnavailable instead if preferred.
  minAvailable: 1

  # Maximum pods that can be unavailable during disruptions.
  # Mutually exclusive with minAvailable — uncomment and set
  # minAvailable to null to use this instead.
  # maxUnavailable: 1

  # Eviction policy for unhealthy pods (Kubernetes 1.27+).
  # "IfHealthy"    — unhealthy pods count toward the budget (default).
  # "AlwaysAllow"  — unhealthy pods can always be evicted,
  #                  preventing them from blocking node drain.
  # unhealthyPodEvictionPolicy: AlwaysAllow

##########################################################
# Service Configuration
##########################################################
service:
  enabled: true # Enable/disable Kubernetes Service
  additionalLabels: {} # Additional labels for Service
  annotations: {} # Annotations for Service
  type: ClusterIP # Service type (ClusterIP, NodePort, LoadBalancer)
  ports: [] # Additional ports

##########################################################
# Role-Based Access Control (RBAC)
##########################################################
rbac:
  enabled: false # Enable/disable RBAC
  serviceAccount:
    enabled: false # Enable/disable ServiceAccount
    name: "" # Custom ServiceAccount name
    additionalLabels: {} # Additional labels
    annotations: {} # Annotations

##########################################################
# Kubernetes Secret Configuration (Quick Start)
##########################################################
secret:
  enabled: true

##########################################################
# External Secrets Configuration
##########################################################
externalSecret:
  enabled: false # Enable/disable ExternalSecrets
  secretStore:
    name: aws-secrets-manager # Secret store reference name
    kind: ClusterSecretStore # Type of secret store
  refreshInterval: "1h" # Frequency of secret sync
  files: {}

##########################################################
# Ingress Configuration
##########################################################
ingress:
  enabled: false # Enable/disable Ingress
  ingressClassName: alb # Specify the Ingress class
  hosts:
    - host: k8s.formbricks.com
      paths:
        - path: /
          pathType: "Prefix"
          serviceName: "formbricks"
  annotations: {} # Ingress annotations

##########################################################
# Redis Configuration
##########################################################
redis:
  enabled: true # Enable/disable Redis
  externalRedisUrl: ""
  fullnameOverride: "formbricks-redis"
  architecture: standalone
  auth:
    enabled: true
    existingSecret: "formbricks-app-secrets"
    existingSecretPasswordKey: "REDIS_PASSWORD"
  networkPolicy:
    enabled: false
  master:
    persistence:
      enabled: true

##########################################################
# Service Monitor to collect Prometheus metrices
##########################################################
serviceMonitor:
  enabled: true

  # Additional labels
  additionalLabels:
  # key: value

  # Additional annotations
  annotations:
  # key: value

  # List of the endpoints of service from which prometheus will scrape data
  endpoints:
    - interval: 5s
      path: /metrics
      port: metrics

##########################################################
# PostgreSQL Configuration
##########################################################
postgresql:
  enabled: true # Enable/disable PostgreSQL
  externalDatabaseUrl: ""
  global:
    security:
      allowInsecureImages: true
  fullnameOverride: "formbricks-postgresql"
  image:
    repository: pgvector/pgvector
    tag: 0.8.0-pg17
  auth:
    username: formbricks
    database: formbricks
    existingSecret: "formbricks-app-secrets"
    secretKeys:
      adminPasswordKey: "POSTGRES_ADMIN_PASSWORD"
      userPasswordKey: "POSTGRES_USER_PASSWORD"
  primary:
    networkPolicy:
      enabled: false
    persistence:
      enabled: true
      size: 10Gi
    podSecurityContext:
      enabled: true
      fsGroup: 1001
      runAsUser: 1001
    containerSecurityContext:
      enabled: true
      runAsUser: 1001
      readOnlyRootFilesystem: false
